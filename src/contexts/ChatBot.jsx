import { useState, useRef, useEffect } from "react";
import { useTheme } from "../contexts/ThemeContext";
import { FaRobot } from "react-icons/fa";

const FAQ = {
  "login issue":
    "ðŸ”‘ Try refreshing the site ðŸ”„, or log out and log back in. If the issue continues, check your ðŸŒ network.",
  "forgot password":
    "ðŸ™ˆ Use the 'Forgot Password' link to reset your password via your ðŸ“§ registered email.",
  "register issue":
    "ðŸ“ Make sure all fields are filled correctly âœ…, and your email is valid ðŸ“¬.",
  features:
    "ðŸ‘¨â€ðŸ’¼ Admins manage employees, ðŸ‘©â€ðŸ’» HR can analyze salary data ðŸ“Š, and ðŸ‘¨â€ðŸŽ“ Staff can view payslips ðŸ’³.",
  "salary slip":
    "ðŸ’° Employees can view payslips from the Staff Dashboard ðŸ“‚ under 'Payslips'.",
  "update profile":
    "ðŸ‘¤ Go to Profile Settings âš™ï¸ to update your details and ðŸ’¾ save changes.",
  "admin add employee":
    "âž• Admins can add employees via the Admin Dashboard â†’ 'Add Employee'.",
  "admin delete employee":
    "âŒ Admins can delete employees from the Admin Dashboard â†’ 'Employee List'.",
  "hr generate report":
    "ðŸ“Š HR can generate reports under 'Reports' in the HR Dashboard.",
  "staff view payslip":
    "ðŸ‘€ Staff can access their payslips under 'Payslips' in the Staff Dashboard.",
  "salary not updated":
    "âš ï¸ Ensure salary was generated by HR/Admin; ðŸ”„ refresh your page to see updates.",
  "change password":
    "ðŸ”’ Go to Profile â†’ Change Password and follow the prompts ðŸ“.",
  logout: "ðŸšª Click the 'Logout' button on the top-right corner â†—ï¸.",
  "dashboard not loading":
    "ðŸ–¥ï¸ Clear your browser cache ðŸ§¹ and ðŸ”„ refresh the dashboard.",
  "user role issue":
    "ðŸ‘® Check your assigned role; only Admins/HR can access specific features ðŸ”‘.",
  "generate salary":
    "ðŸ’¸ Admins generate salary via Admin Dashboard â†’ 'Generate Salary'.",
  "view report": "ðŸ“„ Reports can be viewed by HR under 'Reports' section.",
  "export payslip":
    "â¬‡ï¸ Click 'Download' on the payslip to export as ðŸ“‘ PDF.",
  "email not received":
    "ðŸ“§ Check spam folder ðŸ—‘ï¸; emails are sent after actions like registration or password reset.",
  "notification issue":
    "ðŸ”” Ensure notifications are enabled in Profile Settings âš™ï¸.",
  "login timeout":
    "â° Try logging in again; session may have expired ðŸ’¤.",
  "duplicate employee":
    "ðŸ‘¥ Check if the employee is already added before adding a new one.",
  "salary calculation":
    "ðŸ§® Salary is calculated based on configured salary components in Admin Dashboard ðŸ“Š.",
  "edit salary":
    "âœï¸ Admins can edit salary components before finalizing salary generation.",
  "report export":
    "ðŸ“¤ Reports can be exported in CSV ðŸ“Š or PDF ðŸ“‘ format from HR Dashboard.",
  "reset password link expired":
    "â³ Request a new reset link ðŸ”— from the login page.",
  "unauthorized access":
    "ðŸš« You are trying to access a restricted page; check your role permissions ðŸ”‘.",
  "employee details update":
    "ðŸ‘¤ Admins can update employee details via Employee List â†’ âœï¸ Edit.",
  "payslip format":
    "ðŸ“‘ Payslips are generated in PDF format showing all salary components ðŸ’µ.",
  "browser not supported":
    "ðŸŒ Use Chrome, Firefox, or Edge for best compatibility âœ….",
  "session expired":
    "âŒ› Login again ðŸ”‘; sessions expire after inactivity for security reasons ðŸ›¡ï¸.",
  "bulk employee upload":
    "ðŸ“‚ Admins can upload CSV files via Admin Dashboard â†’ Bulk Upload.",
  "hr access denied":
    "ðŸš« Ensure you are logged in as HR or Admin to access this feature ðŸ”‘.",
  "delete payslip":
    "âŒ Payslips cannot be deleted; you may regenerate salary if needed ðŸ’°.",
  "profile picture":
    "ðŸ–¼ï¸ Upload profile picture under Profile Settings â†’ Edit Profile ðŸ‘¤.",
  "generate report error":
    "âš ï¸ Ensure the data exists for selected month ðŸ“… and employee ðŸ‘¥.",
  "system slow":
    "ðŸ¢ Check your network ðŸŒ; heavy data may slow down the system.",
  "tax details":
    "ðŸ’¼ Admins enter tax info in Employee Details â†’ Salary Components.",
  "attendance data missing":
    "ðŸ“… Ensure attendance is recorded before generating salary.",
  "app update":
    "ðŸ“² Check for notifications ðŸ”” about system updates from Admin.",
  "mobile access":
    "ðŸ“± System is responsive; use mobile browser to access dashboards ðŸŒ.",
  "support contact":
    "â˜Žï¸ Contact HR/Admin via provided email ðŸ“§ for unresolved issues.",
  "salary mismatch":
    "ðŸ” Verify salary components and deductions; regenerate if needed ðŸ’µ.",
  "duplicate payslip":
    "âš ï¸ Check if salary was already generated for the month ðŸ“….",
  "forgot username":
    "ðŸ™‹ Use your registered email ðŸ“§ to login or reset credentials.",
  "employee role assignment":
    "ðŸ‘” Admins assign roles under Employee Details â†’ Role.",
  "generate bonus":
    "ðŸŽ Bonus can be added before salary generation in Admin Dashboard.",
  "leave deduction":
    "ðŸ–ï¸ Leaves are automatically calculated if configured in salary rules.",
  "employee resignation":
    "ðŸ‘‹ Mark employee as resigned under Employee List â†’ Edit.",
  "audit report":
    "ðŸ“‘ Admins/HR can download audit reports under 'Reports'.",
  "system backup":
    "ðŸ’¾ Admins can trigger backup from Admin Dashboard â†’ Backup.",
  "change email":
    "ðŸ“§ Update your email in Profile Settings â†’ Edit Profile.",
  "notification email":
    "ðŸ”” Enable notification emails in Profile â†’ Preferences.",
  "export all payslips":
    "ðŸ“¤ Admins can export multiple payslips via Bulk Export ðŸ“‘.",
  "salary history":
    "ðŸ“œ View previous monthsâ€™ salaries under 'Salary History'.",
  "hr dashboard overview":
    "ðŸ“Š HR dashboard provides analysis charts ðŸ“ˆ and salary statistics ðŸ’°.",
  "admin dashboard overview":
    "ðŸ–¥ï¸ Admin dashboard shows employee list ðŸ‘¥, salary stats ðŸ’µ, and system settings âš™ï¸.",
  "employee login":
    "ðŸ‘¨â€ðŸ’¼ Employees login using their registered email ðŸ“§ and password ðŸ”‘.",
  "forgot password email not received":
    "ðŸ“­ Check spam or request a new reset email ðŸ”„.",
  "salary approval":
    "âœ… Admins must approve salary before it is finalized ðŸ’°.",
  "update salary components":
    "âœï¸ Edit components under Employee Details â†’ Salary Components.",
  "leave management":
    "ðŸ“… HR manages leaves under HR Dashboard â†’ Leaves.",
  "bonus management":
    "ðŸŽ‰ HR/Admin can add bonuses under Employee â†’ Salary Components.",
  "deduction management":
    "âž– Deductions are managed under Salary Components.",
  "generate payslip pdf":
    "â¬‡ï¸ Click 'Download' on the payslip page ðŸ“‘.",
  "view report pdf":
    "ðŸ“„ Reports can be downloaded as PDF ðŸ“‘ or CSV ðŸ“Š.",
  "system error":
    "âš ï¸ Try refreshing the page ðŸ”„; contact Admin if it persists ðŸ“ž.",
  "unauthorized action":
    "ðŸš« Your role does not have permission for this action ðŸ”‘.",
  "reset API key":
    "ðŸ” Admin can reset API key under System Settings âš™ï¸.",
  "data import error":
    "ðŸ“‚ Check CSV format; required fields must be included âœ….",
  "salary formula":
    "ðŸ“Š Salary = Basic + Allowances + Bonus ðŸŽ - Deductions âž–.",
  "employee ID not found":
    "â“ Verify the employee exists and check spelling ðŸ”.",
  "generate payslip error":
    "âš ï¸ Ensure salary is generated before downloading payslip ðŸ“‘.",
  "admin settings":
    "âš™ï¸ Admins can configure system settings under Admin Dashboard â†’ Settings.",
  "hr settings":
    "ðŸ‘©â€ðŸ’¼ HR can configure report templates ðŸ“„ and notifications ðŸ””.",
  "email template":
    "âœ‰ï¸ Customize emails under System Settings â†’ Email Templates.",
  "system logs":
    "ðŸ“œ Admins can view system logs under Admin Dashboard â†’ Logs.",
  "backup restore":
    "â™»ï¸ Admins can restore backup via Admin Dashboard â†’ Backup.",
  "monthly report":
    "ðŸ—“ï¸ HR can generate monthly reports under Reports â†’ Monthly.",
  "yearly report":
    "ðŸ“† HR can generate yearly reports under Reports â†’ Yearly.",
  "employee status":
    "âœ… Check employee status under Employee List â†’ Status.",
  "salary preview":
    "ðŸ‘€ Preview salary before generating payslip under Admin Dashboard.",
  "forgot password OTP":
    "ðŸ”¢ Enter the OTP sent to your registered email ðŸ“§.",
  "change language":
    "ðŸŒ Go to Profile â†’ Preferences â†’ Language.",
  Boss: "ðŸ‘‘ Karthikeya Devarakonda â€” The Mastermind, Visionary & Ruler of the Code Kingdom ðŸ‘¨â€ðŸ’»âš”ï¸",
  Inventor: "ðŸ’¡ Karthikeya Devarakonda â€” A Full Stack Wizard ðŸ§™â€â™‚ï¸âœ¨, Code Alchemist âš¡, and Digital Architect ðŸ—ï¸ who turns caffeine â˜• into powerful apps ðŸš€",
  "About Karthikeya": "ðŸŒŸ Meet Karthikeya Devarakonda â€” The Creative Brain ðŸ§ , Full Stack Superhero ðŸ¦¸â€â™‚ï¸, and Innovator Extraordinaire ðŸŒâœ¨. He builds dreams into digital reality ðŸ’»âš¡, leading with passion â¤ï¸, skill ðŸŽ¯, and unstoppable energy ðŸ”¥!",
  "download all reports":
    "â¬‡ï¸ Use Bulk Export under Reports section ðŸ“‘.",
  "generate bonus pdf":
    "ðŸŽ Bonuses are included in payslip PDF automatically ðŸ“„.",
  "view payslip history":
    "ðŸ“œ Employees can view past payslips in Payslip History.",
  "system maintenance":
    "âš™ï¸ System may be down temporarily â³; check Admin notifications ðŸ””.",
  "employee promotion":
    "ðŸ“ˆ Update role under Employee Details â†’ Role.",
  "salary component missing":
    "ðŸš§ Add missing component before generating salary ðŸ’µ.",
  "attendance report":
    "ðŸ—“ï¸ HR can generate attendance reports under Reports ðŸ“Š.",
  "tax calculation":
    "ðŸ’° System automatically calculates taxes based on components.",
  "leave report":
    "ðŸ“„ HR can export leave reports for all employees ðŸ‘¥.",
  "overtime calculation":
    "â±ï¸ Overtime is added automatically based on attendance records ðŸ“.",
  "employee transfer":
    "ðŸ”„ Update department under Employee Details â†’ Department.",
  "generate payslip bulk":
    "ðŸ‘¥ Admins can generate payslips for multiple employees at once ðŸ“‘.",
  "password strength":
    "ðŸ” Use at least 8 characters with numbers ðŸ”¢ and symbols âœ¨.",
  "failed login attempt":
    "ðŸš« Too many failed attempts will temporarily lock your account â³.",
  "system notification":
    "ðŸ”” Notifications appear on top-right corner â†—ï¸ of the dashboard.",
  "email verification":
    "âœ… Verify email using the link sent during registration ðŸ“§.",
  "disable account":
    "ðŸš« Admins can disable accounts under Employee Details â†’ Status.",
  "reactivate account":
    "â™»ï¸ Admins can reactivate accounts under Employee Details â†’ Status.",
  "salary report export":
    "ðŸ“¤ HR can export salary reports in PDF ðŸ“‘ or CSV ðŸ“Š format.",
  "update system":
    "ðŸ› ï¸ Admins update system via Admin Dashboard â†’ Updates.",
  "view employee list":
    "ðŸ‘¥ Admins/HR can view the complete employee list ðŸ“‹.",
  "forgot username email":
    "ðŸ“§ Check your registered email for username reminder ðŸ“¨.",
  "generate annual report":
    "ðŸ“† HR can generate annual reports under Reports â†’ Yearly.",
  bye: "ðŸ‘‹ Bye sir, Have a great Day..! â˜€ï¸",
  "thank you": "ðŸ™ You're always welcome..! ðŸŒŸ",
  thankyou: "ðŸ™ You're always welcome..! ðŸŒŸ",
  hi: "ðŸ‘‹ Hello sir, how can I help you today? ðŸ˜ƒ",
  hello: "ðŸ‘‹ Hello sir, how can I help you today? ðŸ˜ƒ",
  process:
    "âš¡ If you're a new user, first register ðŸ“ with your credentials, and then try login ðŸ”‘",
};


const getBestAnswer = (input) => {
  const userWords = input.toLowerCase().match(/\w+/g) || [];
  let bestMatch = "";
  let maxScore = 0;

  for (const question of Object.keys(FAQ)) {
    const questionWords = question.toLowerCase().match(/\w+/g) || [];
    const score = userWords.filter((w) => questionWords.includes(w)).length;
    if (score > maxScore) {
      maxScore = score;
      bestMatch = question;
    }
  }

  return maxScore > 0 ? FAQ[bestMatch] : "Sorry, I can't help with that.";
};

const getTopFaqSuggestions = (input) => {
  if (!input.trim()) return Object.keys(FAQ).slice(0, 4);

  const userWords = input.toLowerCase().match(/\w+/g) || [];
  const scoredFaqs = Object.keys(FAQ).map((q) => {
    const questionWords = q.toLowerCase().match(/\w+/g) || [];
    const score = userWords.filter((w) => questionWords.includes(w)).length;
    return { question: q, score };
  });

  return scoredFaqs
    .sort((a, b) => b.score - a.score)
    .slice(0, 4)
    .map((item) => item.question);
};

export default function ChatBot() {
  const { isDarkMode } = useTheme();
  const [open, setOpen] = useState(false);
  const [messages, setMessages] = useState([]);
  const [input, setInput] = useState("");
  const [typing, setTyping] = useState(false);
  const messagesEndRef = useRef(null);

  const sendMessage = (text) => {
    if (!text.trim()) return;

    setMessages((prev) => [...prev, { sender: "user", text }]);
    setInput("");
    setTyping(true);

    setTimeout(() => {
      const answer = getBestAnswer(text);
      setTyping(false);
      setMessages((prev) => [...prev, { sender: "bot", text: answer }]);
    }, 1000);
  };

  useEffect(() => {
    messagesEndRef.current?.scrollIntoView({ behavior: "smooth" });
  }, [messages, typing]);

  return (
    <>
      {open && (
        <div
          className="fixed inset-0 bg-black/40 backdrop-blur-sm z-[999]"
          onClick={() => setOpen(false)}
        />
      )}

      {open && (
        <div
          className={`fixed flex flex-col shadow-2xl z-[1000] transition-all duration-300 
    inset-0 w-full h-full p-3 rounded-none
    sm:inset-auto sm:bottom-20 sm:right-6 sm:w-80 sm:h-[480px] sm:rounded-2xl sm:p-4
    ${
      isDarkMode
        ? "bg-gradient-to-br from-gray-900 via-gray-800 to-gray-900 text-gray-100 border border-gray-700/40"
        : "bg-gradient-to-br from-white via-blue-50 to-white text-gray-800 border border-gray-200/40"
    }`}
        >
          <div className="flex items-center justify-between mb-3 ">
            <h3 className="font-semibold flex items-center gap-2 text-sm sm:text-base">
              ðŸ¤– Salary Bot
            </h3>
            <button
              onClick={() => setOpen(false)}
              className={`hover:opacity-80 transition-colors text-lg ${
                isDarkMode ? "text-gray-300" : "text-gray-500"
              }`}
            >
              âœ•
            </button>
          </div>

          <div className="flex-1 overflow-y-auto space-y-2 px-1 mb-3 custom-scrollbar">
            {messages.map((msg, i) => (
              <div
                key={i}
                className={`flex items-end ${
                  msg.sender === "user" ? "justify-end" : "justify-start"
                }`}
              >
                {msg.sender === "bot" && (
                  <div
                    className={`w-7 h-7 rounded-full flex items-center justify-center text-xs mr-1
                  ${isDarkMode ? "bg-gray-700" : "bg-gray-300"}`}
                  >
                    ðŸ¤–
                  </div>
                )}

                <div
                  className={`p-2 rounded-2xl max-w-[75%] text-xs sm:text-sm shadow-sm
                  ${
                    msg.sender === "user"
                      ? isDarkMode
                        ? "bg-teal-500 text-white"
                        : "bg-blue-500 text-white"
                      : isDarkMode
                      ? "bg-gray-800 text-gray-100"
                      : "bg-gray-100 text-gray-800"
                  }`}
                >
                  {msg.text}
                </div>

                {msg.sender === "user" && (
                  <div
                    className={`w-7 h-7 rounded-full flex items-center justify-center text-xs ml-1
                  ${
                    isDarkMode
                      ? "bg-teal-500 text-white"
                      : "bg-blue-500 text-white"
                  }`}
                  >
                    ðŸ‘¤
                  </div>
                )}
              </div>
            ))}

            {typing && (
              <div className="flex items-end">
                <div
                  className={`w-7 h-7 rounded-full flex items-center justify-center text-xs mr-1
                ${isDarkMode ? "bg-gray-700" : "bg-gray-300"}`}
                >
                  ðŸ¤–
                </div>
                <div
                  className={`p-2 rounded-xl max-w-[55%] text-xs flex gap-1
                ${
                  isDarkMode
                    ? "bg-gray-800 text-gray-100"
                    : "bg-gray-100 text-gray-800"
                }`}
                >
                  <span className="animate-bounce">.</span>
                  <span className="animate-bounce animation-delay-200">.</span>
                  <span className="animate-bounce animation-delay-400">.</span>
                </div>
              </div>
            )}

            <div ref={messagesEndRef} />
          </div>

          <div className="flex gap-2 mt-auto">
            <input
              type="text"
              value={input}
              onChange={(e) => setInput(e.target.value)}
              onKeyDown={(e) => e.key === "Enter" && sendMessage(input)}
              placeholder="Type a message..."
              className={`flex-1 border rounded-full px-3 py-2 text-sm focus:outline-none focus:ring-2
            ${
              isDarkMode
                ? "bg-gray-900/50 text-gray-100 border-gray-600 focus:ring-teal-400"
                : "bg-white text-black border-gray-300 focus:ring-blue-400"
            }`}
            />
            <button
              onClick={() => sendMessage(input)}
              className={`rounded-full px-4 py-2 text-sm font-medium shadow-md transition-transform hover:scale-105
              ${
                isDarkMode
                  ? "bg-teal-500 hover:bg-teal-600 text-white"
                  : "bg-blue-500 hover:bg-blue-600 text-white"
              }`}
            >
              Send
            </button>
          </div>

          <div className="flex flex-wrap gap-2 mt-3">
            {getTopFaqSuggestions(input).map((q, i) => (
              <button
                key={i}
                onClick={() => sendMessage(q)}
                className={`text-xs px-3 py-1 rounded-full font-medium transition-colors hover:opacity-80
                ${
                  isDarkMode
                    ? "bg-gray-700/60 text-white"
                    : "bg-gray-200/80 text-black"
                }`}
              >
                {q}
              </button>
            ))}
          </div>
        </div>
      )}

      <button
        onClick={() => setOpen(!open)}
        className={`fixed bottom-4 right-4 sm:bottom-6 sm:right-6 w-12 h-12 sm:w-16 sm:h-16 rounded-full flex items-center justify-center shadow-2xl hover:scale-110 transition-transform duration-300
        ${
          isDarkMode
            ? "bg-[#ffffff33] border border-gray-500"
            : "bg-[#dbeafecc] border border-gray-300"
        }`}
      >
        <span
          className={`text-xl sm:text-2xl ${
            isDarkMode ? "text-teal-400" : "text-blue-600"
          } animate-pulse`}
        >
          <FaRobot />
        </span>
      </button>
    </>
  );
}
